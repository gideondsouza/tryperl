Ext.define("Ace.Editor",{extend:"Ext.form.field.TextArea",alias:"widget.aceeditor",editorId:null,editor:null,initComponent:function(){var me=this;me.editorId=Ext.id();var config={width:640,height:300,fieldSubTpl:['<div id="{id}" {inputAttrTpl}>','<div id="'+me.editorId+'" class="amun-ace-editor"></div>',"</div>",{disableFormats:true}]};Ext.apply(me,config);me.callParent()},afterRender:function(){var me=this;me.callParent(arguments);me.editor=ace.edit(me.editorId);me.editor.setTheme("ace/theme/eclipse");me.editor.getSession().setMode("ace/mode/html");me.editor.setValue(me.rawValue,-1)},setRawValue:function(value){var me=this;me.rawValue=value;return value},getRawValue:function(){var me=this;var value=me.editor!=null?me.editor.getValue():"";return value}});Ext.define("HelpWindow",{extend:"Ext.window.Window",title:"Help",height:200,width:400,layout:"fit",items:{xtype:"label",html:"<p>Shortcuts:</p><ol>"+"<li>>Ctrl + / toggle comment.</li> <li>Yes, it's a lot like textmate :). Note: Replace Ctrl with Cmd on Mac.</li></ol>"}});Ext.define("AboutWindow",{extend:"Ext.window.Window",title:"Help",height:200,width:400,layout:"fit",items:{xtype:"label",html:"www.tryperl.com was built with ExtJS, Perl, Dancer, Amazon EC2 on RHEL.<br/>"+'Built by <a href="http://www.gideondsouza.com"/>Gideon Dsouza</a>'}});Ext.define("TryPerl.Constants",{singleton:true,OUTPUT_SUCCESS_COLOR:"#D9EDF7",OUTPUT_SUCCESS_COLOR_TEXT:"#3A87AD",OUTPUT_FAILURE_COLOR:"#F2DEDE",OUTPUT_FAILURE_COLOR_TEXT:"#B94A48",GITHUB_GIST_URL:"https://gist.github.com/",GITHUB_USER_URL:"https://github.com/",DELETE_ICON_URL:"./css/icons/cross.png",OCTOCAT_ICON_URL:"./css/icons/octocat.png",EDIT_ICON_URL:"./css/icons/script_edit.png",USER_AVATAR_ICON_URL:"./css/icons/octocat.png",LOGOFF_URL_PART:"logout",ABOUT_PART:"about",GITHUB_USER_URL:"http://www.github.com/"+Globals.Username,ANON_USER:"xxx"});Ext.define("TryPerl.CodeManager",{singleton:true,getAllFiles:function(callBack){var ret=[];Ext.Ajax.request({url:"/getgists",success:function(response){var json=Ext.decode(response.responseText);for(var i=0;i<json.length;i++){var theFile=Ext.create("CodeFileModel",{filename:json[i].filename,file_id:json[i].file_id,starred:false,created_at:"",url:"",comment_count:json[i].comment_count,description:json[i].description});ret.push(theFile)}callBack(ret)}})},getFileContent:function(id,callBack){Ext.Ajax.request({url:"/getgistcontent/"+id,success:function(response){var content=response.responseText;var filename=id;var srch=content.search("#F:");if(srch!=-1){filename=content.substr(srch+3);content=content.substr(0,srch-1)}callBack(content,filename)}})},newFile:function(theFilename,callBack){Ext.Ajax.request({method:"POST",url:"/newgist",params:{filename:theFilename},success:function(response){console.log(response);callBack()}})},editFile:function(theFilename,theId,theContent,callBack){Ext.Ajax.request({method:"POST",url:"/savegist",params:{filename:theFilename,id:theId,content:theContent},success:function(response){console.log(response);callBack()}})},starFile:function(){},deleteFile:function(){},_makeAjaxCall:function(){}});Ext.define("CodeFileModel",{extend:"Ext.data.Model",fields:[{name:"filename",type:"string"},{name:"file_id",type:"string"},{name:"starred",type:"bool"},{name:"created_at",type:"string"},{name:"url",type:"string"},{name:"comment_count",type:"int"},{name:"description",type:"string"}]});Ext.define("TryPerl.CodeFileStore",{extend:"Ext.data.Store",autoDestroy:true,storeId:"codeFileStore",model:"CodeFileModel"});Ext.define("TryPerl.FileGrid",{extend:"Ext.grid.Panel",alias:"widget.tryperlfilegrid",id:"tryperlfilegrid",preventHeader:true,title:"Files",columns:[{text:"File Name",dataIndex:"filename",flex:1},{text:"Id",dataIndex:"file_id"},{xtype:"actioncolumn",width:50,items:[{icon:TryPerl.Constants.EDIT_ICON_URL,tooltip:"Open for Edit",handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);Globals.getEventBus().fireEvent("openFile",rec.data)}},{icon:TryPerl.Constants.OCTOCAT_ICON_URL,tooltip:"Open in Github",handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);window.open(TryPerl.Constants.GITHUB_GIST_URL+rec.get("file_id"))}}]}],minheight:"100px",width:"100%",initComponent:function(){this.initStore();this.on("afterrender",this.onAfterRender);this.callParent(arguments)},initStore:function(){Ext.create("TryPerl.CodeFileStore");Ext.applyIf(this,{store:Ext.data.StoreManager.lookup("codeFileStore")})},onItemDblClick:function(view,record,item,index,e,eOpts){Globals.getEventBus().fireEvent("openFile",record.data)},onAfterRender:function(){var me=this;this.loadAllFiles();this.on("itemdblclick",this.onItemDblClick)},loadAllFiles:function(){var me=this;me.disable();TryPerl.CodeManager.getAllFiles(function(files){me.store.loadData(files,false);me.enable()})}});Ext.define("TryPerl.Toolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.tryperltoolbar",width:"100%",items:["<b>TryPerl</b>",{text:"New",iconCls:"newIcon",handler:function(evt,data){Ext.Msg.prompt("New Script File","Please enter a Filename:",function(btn,text){if(btn=="ok"&&text!=""){Globals.getEventBus().fireEvent("newScript",{filename:text})}},this,false,"Untitled")}},{text:"Save",iconCls:"saveIcon",handler:function(evt,data){Globals.getEventBus().fireEvent("saveScript",{content:AceManager.Editor.getValue()})}},{text:"Run",iconCls:"goIcon",handler:function(evt,data){Globals.getEventBus().fireEvent("runScript",{content:AceManager.Editor.getValue()})}},{text:"Validate",iconCls:"checkIcon",handler:function(evt,data){Globals.getEventBus().fireEvent("validateScript",{content:AceManager.Editor.getValue()})}},"->","-",{xtype:"splitbutton",text:"Share",iconCls:"shareIcon",menu:new Ext.menu.Menu({items:[{text:"Google+",iconCls:"googleplusIcon",handler:function(){window.open("https://plus.google.com/share?url="+encodeURIComponent(window.location))}},{text:"Twitter",iconCls:"twitterIcon",handler:function(){window.open("https://twitter.com/intent/tweet?text=Check out my %23perl script at "+encodeURIComponent(window.location))}},{text:"Facebook",iconCls:"facebookIcon",handler:function(){window.open("http://www.facebook.com/share.php?u="+encodeURIComponent(window.location))}},{text:"Email",iconCls:"emailIcon",handler:function(){window.open("mailto:?body=Check out my perl script "+encodeURIComponent(window.location)+"&subject=Hey, try perl!")}}]})},"-",{id:"btnLogin",text:"Login w/ GitHub",iconCls:"octocatIcon",handler:function(evt,data){window.location.href=Globals.LoginUrl}},{id:"btnUserName",text:Globals.Username,icon:Globals.getGravatarUrl(),handler:function(evt,data){window.open(TryPerl.Constants.GITHUB_USER_URL)}},{id:"btnLogOff",text:"Log Off",iconCls:"dooroutIcon",handler:function(){window.location.href=Globals.getBaseUrl()+TryPerl.Constants.LOGOFF_URL_PART}},"-",{text:"Help",iconCls:"helpIcon",handler:function(){var win=Ext.create("HelpWindow");win.show()}},{text:"About",iconCls:"infoIcon",handler:function(){window.location.href=Globals.getBaseUrl()+TryPerl.Constants.ABOUT_PART}}]});Ext.define("TryPerl.OutputPanel",{extend:"Ext.panel.Panel",alias:"widget.tryperloutputpanel",id:"outputpanel",preventHeader:true,height:"100%",tpl:Ext.create("Ext.XTemplate","<pre>{msg}</pre>",{compiled:true}),showSuccessMessage:function(theMsg){this.update({msg:theMsg});this.body.setStyle("background-color",TryPerl.Constants.OUTPUT_SUCCESS_COLOR);this.body.setStyle("color",TryPerl.Constants.OUTPUT_SUCCESS_COLOR_TEXT)},showFailureMessage:function(msg){this.update(msg);this.body.setStyle("background-color",TryPerl.Constants.OUTPUT_FAILURE_COLOR);this.body.setStyle("color",TryPerl.Constants.OUTPUT_FAILURE_COLOR_TEXT)}});Ext.define("TryPerl.Viewport",{extend:"Ext.container.Viewport",layout:"border",showLoading:function(){},hideLoading:function(){}});Ext.define("TryPerlIde",{extend:"TryPerl.Viewport",items:[{xtype:"tryperltoolbar",renderTo:document.body},{region:"west",collapsible:true,title:Globals.getLeftPanelTitle(),split:true,width:300,items:{xtype:"tryperlfilegrid"}},{region:"south",title:"Output",items:{xtype:"tryperloutputpanel"},collapsible:true,split:true,height:150,minHeight:100},{region:"center",xtype:"tabpanel",activeTab:0,items:{id:"defaultTab",title:"::Default::",items:[{xtype:"panel",text:"Code",id:"codeEditor",height:"100%",width:"97%"}]}}]});Ext.define("AceManager",{singleton:true,Editor:undefined,_defaultMode:"perl",_defaultTheme:"textmate",aceify:function(id){this.Editor=ace.edit(id);this.setTheme(this._defaultTheme);this.Editor.getSession().setMode("ace/mode/"+this._defaultMode);this._setShortcuts()},setTheme:function(theme){this.Editor.setTheme("ace/theme/"+theme)},_setShortcuts:function(){this.Editor.commands.addCommand({name:"saveCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(editor){console.log("Called Saved on editor..")}});this.Editor.commands.addCommand({name:"validateCommand",bindKey:{win:"Ctrl-Shift-V",mac:"Ctrl-Shift-V"},exec:function(editor){}});this.Editor.commands.addCommand({name:"runCommand",bindKey:{win:"Ctrl-R",mac:"Command-R"},exec:function(editor){}})}});Ext.define("MainEventBus",{extend:"Ext.util.Observable",constructor:function(){var me=this;me.callParent();this.addEvents("runScript","saveScript","newScript","validateScript","logoff")}});Ext.define("MainController",{singleton:true,prepareHandlers:function(){Globals.getEventBus().on("runScript",this.onRunScript);Globals.getEventBus().on("validateScript",this.onValidateScript);Globals.getEventBus().on("saveScript",this.onSaveScript);Globals.getEventBus().on("newScript",this.onNewScript);Globals.getEventBus().on("openFile",this.onOpenFile)},onRunScript:function(data){PerlCompiler.runCode(data.content,function(res){Globals.showSuccessMessage(res.output)})},onValidateScript:function(data){PerlCompiler.compileCode(data.content,function(res){if(res.success){Globals.showSuccessMessage(res.output)}else{if(res.output==""){Globals.showFailureMessage("Tip: Balance or remove any single quotes inside comments. This is a known issue.")}else{Globals.showFailureMessage(res.output)}}})},onSaveScript:function(data){if(Globals.CurrentFileId!=Globals.DefaultFile){Globals.disableCodeEditor();Globals.disableGrid();TryPerl.CodeManager.editFile(Globals.CurrentFileName,Globals.CurrentFileId,data.content,function(){Globals.showSuccessMessage(Globals.CurrentFileName+" was saved");Globals.enableCodeEditor();Globals.enableGrid()})}else{Ext.Msg.alert("Error","Whoops! This is a shared default file. Please don't save it.")}},onNewScript:function(data){TryPerl.CodeManager.newFile(data.filename+".pl",function(){Globals.reloadAllFiles();Globals.showSuccessMessage(data.filename+".pl was created on gists.github.com. You should see this file on the left grid. DOUBLE-CLICK or click EDIT icon to open.")})},onOpenFile:function(data){Globals.showLoadingFileMessage();Globals.disableCodeEditor();TryPerl.CodeManager.getFileContent(data.file_id,function(content){Globals.openFile(data.file_id,content,data.filename);Globals.enableCodeEditor()})}});Ext.define("PerlCompiler",{singleton:true,compileCode:function(code,callBack){console.log("Code I got to COMPILE:");console.log(code);this._makeRequest("/compile",code.replace(/(\r\n|\n|\r)/gm,""),callBack)},runCode:function(code,callBack){console.log("Code I got to RUN:");console.log(code);this._makeRequest("/run",code,callBack)},_makeRequest:function(the_url,code,callBack){Ext.Ajax.request({url:the_url,method:"POST",params:{content:code},success:function(response){var result=Ext.decode(response.responseText);console.log(result);callBack(result)}})}});